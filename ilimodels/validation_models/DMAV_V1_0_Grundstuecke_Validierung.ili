INTERLIS 2.4;

MODEL DMAV_V1_0_Grundstuecke_Validierung (de) 
AT "https://www.kgk-cgc.ch/" 
VERSION "2025-03-30" =
  
IMPORTS UNQUALIFIED INTERLIS;
IMPORTS UNQUALIFIED Text_V2;
IMPORTS UNQUALIFIED Math_V2_1;
IMPORTS UNQUALIFIED ObjectPool_V1_0;
IMPORTS UNQUALIFIED Elements_V1_0;
IMPORTS DMAVTYM_Topologie_V1_0;
IMPORTS DMAV_FixpunkteAVKategorie3_V1_0;
IMPORTS DMAV_Bodenbedeckung_V1_0;
IMPORTS DMAV_Einzelobjekte_V1_0;
IMPORTS DMAV_Nomenklatur_V1_0;
IMPORTS DMAV_Grundstuecke_V1_0;
IMPORTS DMAV_Rohrleitungen_V1_0;
IMPORTS DMAV_HoheitsgrenzenAV_V1_0;
IMPORTS DMAV_Toleranzstufen_V1_0;
IMPORTS DMAV_Gebaeudeadressen_V1_0;
IMPORTS KGKCGC_FPDS2_V1_1;
IMPORTS FixpunkteLV_V1_0;

     VIEW TOPIC Grundstuecke_Validierung = 
    DEPENDS ON DMAV_Grundstuecke_V1_0.Grundstuecke;
  
        VIEW v_Grundstueck
            PROJECTION OF DMAV_Grundstuecke_V1_0.Grundstuecke.Grundstueck;
        =
            ALL OF Grundstueck;

            !!@ ilivalid.msg="EGRID darf nicht mit der Zahl 0 beginnen";            
            !!@ ilivalid.msg_de="EGRID darf nicht mit der Zahl 0 beginnen";
            !!@ ilivalid.msg_fr="L'EGRID ne doit pas commencer par un 0 (zéro)";
            !!@ ilivalid.msg_it="L'EGRID non deve comincare con uno 0 (zero)";
            !! AGI SH: Failcase umgesetzt;
            MANDATORY CONSTRAINT CH085554: (
                substring(EGRID,0,1) != "0" 
            ); 

            !!@ ilivalid.msg="Summe der Teilflaechen aus Flaechenmass ist ungleich Gesamtflaechenmass";
            !!@ ilivalid.msg_de="Summe der Teilflaechen aus Flaechenmass ist ungleich Gesamtflaechenmass";
            !!@ ilivalid.msg_fr="La somme des parties de surface inscrite sous Superficie n'est pas égale à la donnée correspondante sous SuperficieTotale";
            !!@ ilivalid.msg_it="La somma delle superfici delle parti di Bene_immobile/DSSP/Miniera non corrisponde alla superficie totale del fondo";
            !! Failcase für Testsuite erstellt (Testsuite_DMAV/DMAV_V1_0_Validierung/DMAV_V1_0_Validierung.Grundstuecke_Validierung.v_Grundstueck.CH085952)
            MANDATORY CONSTRAINT CH085952: 
                Gesamtflaechenmass == Math_V2_1.add(Math_V2_1.add(Elements_V1_0.coalesceN(Math_V2_1.sum("THIS->Liegenschaft->Flaechenmass"),0),Elements_V1_0.coalesceN(Math_V2_1.sum("THIS->SelbstaendigesDauerndesRecht->Flaechenmass"),0)),Elements_V1_0.coalesceN(Math_V2_1.sum("THIS->Bergwerk->Flaechenmass"),0)
            );

            !!@ ilivalid.msg="EGRID Prüfziffer stimmt nicht";
            !!@ ilivalid.msg_de="EGRID Prüfziffer stimmt nicht";
            !!@ ilivalid.msg_fr="Le caractère de contrôle EGRID est erroné";
            !!@ ilivalid.msg_it="La cifra di controllo EGRID è errata";
            !! Umsetzung Phase 1;
            !! Failcase für Testsuite erstellt (Testsuite_DMAV/DMAV_V1_0_Validierung/DMAV_V1_0_Validierung.Grundstuecke_Validierung.v_Grundstueck.CH085551)
            MANDATORY CONSTRAINT CH085551: (
                Math_V2_1.toNumeric(substring(EGRID, 12, 14)) == (97 - Math_V2_1.mod(Math_V2_1.toNumeric(substring(EGRID, 2, 12)), 97))
            );

        END v_Grundstueck;

        VIEW v_Liegenschaft
            PROJECTION OF DMAV_Grundstuecke_V1_0.Grundstuecke.Liegenschaft;
        =
            ALL OF Liegenschaft;

            !!@ ilivalid.check = warning
            !!@ ilivalid.msg="Punkt muss in LFP3 oder Grenzpunkt vorkommen, ausser bei fiktiven Grundstuecken";
            !!@ ilivalid.msg_de="Punkt muss in LFP3 oder Grenzpunkt vorkommen, ausser bei fiktiven Grundstuecken";
            !!@ ilivalid.msg_fr="Le point doit figurer dans le PFP3 ou le point_limite, sauf pour les immeubles fictifs.";
            !!@ ilivalid.msg_it="Il punto deve comparire in PFP3 o in point_limite, ad eccezione degli edifici fittizi.";
            !! Kategorie: modellübergreifend
            !! Umsetzung Phase 2;
            !! Failcase für Testsuite erstellt (Testsuite_DMAV/DMAV_V1_0_Validierung/DMAV_V1_0_Validierung.Grundstuecke_Validierung.v_Liegenschaft_CH086951)
            MANDATORY CONSTRAINT CH086951: (
                NOT(Grundstueck->Fiktiv) => (DMAVTYM_Topologie_V1_0.pointInPoints(THIS, >>Geometrie, Elements_V1_0.concat(
                                                Elements_V1_0.valuesOfPathAnyStructure(ObjectPool_V1_0.allObjects(>DMAV_Grundstuecke_V1_0.Grundstuecke.Grenzpunkt), "Geometrie"),
                                                Elements_V1_0.valuesOfPathAnyStructure(ObjectPool_V1_0.allObjects(>DMAV_FixpunkteAVKategorie3_V1_0.FixpunkteAVKategorie3.LFP3), "Geometrie")), UNDEFINED))
                );

            !!@ ilivalid.msg="Bei Grundstueck mit istVollstaendigkeit=true und mit nur 1 Objekt in Liegenschaft muss NummerTeilgrundstueck leer sein";
            !!@ ilivalid.msg_de="Bei Grundstueck mit istVollstaendigkeit=true und mit nur 1 Objekt in Liegenschaft muss NummerTeilgrundstueck leer sein";
            !!@ ilivalid.msg_fr="Pour un immeuble dont l'attribut Integralite=complet, et formé d'un seul objet dans la table Bien_fonds, l'attribut PartieNumeroImmeuble doit être vide";
            !!@ ilivalid.msg_it="Per i fondi con integralità = si, e un solo oggetto in Bene_immobile, numero_parte_fondo deve restare vuoto";
            !! AGI SH: Failcase umgesetzt;
            MANDATORY CONSTRAINT CH086852: (
                (Grundstueck->IstVollstaendig AND INTERLIS.objectCount(THIS->Liegenschaft) == 1) => NOT(DEFINED(THIS->Liegenschaft->NummerTeilgrundstueck))
            );

            !!@ ilivalid.msg="NummerTeilgrundstueck muss innerhalb des gleichen Grundstuecks eindeutig sein";
            !!@ ilivalid.msg_de="NummerTeilgrundstueck muss innerhalb des gleichen Grundstuecks eindeutig sein";
            !!@ ilivalid.msg_fr="L'attribut PartieNumeroImmeubledoit être univoque pour un même immeuble";
            !!@ ilivalid.msg_it="Il NumeroParteFondo deve essere univoco all'interno dello stesso fondo";
            !! AGI SH: Failcase umgesetzt;
            UNIQUE CH086851:  WHERE DEFINED(NummerTeilgrundstueck): NummerTeilgrundstueck, Grundstueck->Nummer, Grundstueck->NBIdent;

        END v_Liegenschaft;

        VIEW v_SelbstaendigesDauerndesRecht
            PROJECTION OF DMAV_Grundstuecke_V1_0.Grundstuecke.SelbstaendigesDauerndesRecht;
        =
            ALL OF SelbstaendigesDauerndesRecht;

            !!@ ilivalid.msg="NummerTeilgrundstueck muss innerhalb des gleichen Grundstuecks eindeutig sein";
            !!@ ilivalid.msg_de="NummerTeilgrundstueck muss innerhalb des gleichen Grundstuecks eindeutig sein";
            !!@ ilivalid.msg_fr="L'attribut PartieNumeroImmeubledoit être univoque pour un même immeuble";
            !!@ ilivalid.msg_it="Il NumeroParteFondo deve essere univoco all'interno dello stesso fondo";
            !! AGI SH: Failcase umgesetzt;
            UNIQUE CH087251:  WHERE DEFINED(NummerTeilgrundstueck): NummerTeilgrundstueck, Grundstueck->Nummer, Grundstueck->NBIdent;

            !!@ ilivalid.msg="Bei Grundstueck mit IstVollstaendig=true und mit nur 1 Objekt in SelbstaendigDauerndesRecht muss NummerTeilgrundstueck leer sein";
            !!@ ilivalid.msg_de="Bei Grundstueck mit IstVollstaendig=true und mit nur 1 Objekt in SelbstaendigDauerndesRecht muss NummerTeilgrundstueck leer sein";
            !!@ ilivalid.msg_fr="Pour un immeuble dont l'attribut EstComplete=true, et formé d'un seul objet dans la table droit_distinct_permanent, l'attribut PartieNumeroImmeuble doit être vide";
            !!@ ilivalid.msg_it="Per i fondi con integralità=true, e un solo oggetto in DPSSP, numero_parte_fondo deve restare vuoto";
            !! Failcase für Testsuite erstellt (Testsuite_DMAV/DMAV_V1_0_Validierung/DMAV_V1_0_Validierung.Grundstuecke_Validierung.v_Grundstueck.CH087252)
            MANDATORY CONSTRAINT CH087252: (
                Grundstueck->IstVollstaendig AND INTERLIS.objectCount(THIS->SelbstaendigesDauerndesRecht) == 1) => NOT(DEFINED(THIS->SelbstaendigesDauerndesRecht->NummerTeilgrundstueck)
            );

            !!@ ilivalid.msg="Fehlender oder unzulässiger Stützpunkt";
            !!@ ilivalid.msg_de="Fehlender oder unzulässiger Stützpunkt";
            !!@ ilivalid.msg_fr="Il manque un point d'appui, ou bien le point d'appui est erroné";
            !!@ ilivalid.msg_it="La definizione del confine passa per un punto mancante o errato";
            !! Kategorie: modellübergreifend
            !! Umsetzung Phase 2;
            MANDATORY CONSTRAINT CH087351: (
                NOT(Grundstueck->Fiktiv) => (DMAVTYM_Topologie_V1_0.pointInPoints(THIS, >>Geometrie, Elements_V1_0.concat(Elements_V1_0.concat(Elements_V1_0.concat(
                                                Elements_V1_0.valuesOfPathAnyStructure(ObjectPool_V1_0.allObjects(>DMAV_Grundstuecke_V1_0.Grundstuecke.Grenzpunkt), "Geometrie"),
                                                Elements_V1_0.valuesOfPathAnyStructure(ObjectPool_V1_0.allObjects(>DMAV_FixpunkteAVKategorie3_V1_0.FixpunkteAVKategorie3.LFP3), "Geometrie")),
                                                Elements_V1_0.valuesOfPathAnyStructure(ObjectPool_V1_0.filter(ObjectPool_V1_0.allObjects(>KGKCGC_FPDS2_V1_1.FPDS2.FixpunktVersion),"NOT(DEFINED(UntergegangenAm))"), "Geometrie")),
                                                Elements_V1_0.valuesOfPathAnyStructure(ObjectPool_V1_0.allObjects(>FixpunkteLV_V1_0.FixpunkteLV.LFP1), "Geometrie")), UNDEFINED))
                );

        END v_SelbstaendigesDauerndesRecht;

        VIEW v_Bergwerk
            PROJECTION OF DMAV_Grundstuecke_V1_0.Grundstuecke.Bergwerk;
        =
            ALL OF Bergwerk;

            !!@ ilivalid.msg="NummerTeilgrundstueck muss innerhalb des gleichen Grundstücks eindeutig sein";
            !!@ ilivalid.msg_de="NummerTeilgrundstueck muss innerhalb des gleichen Grundstücks eindeutig sein";
            !!@ ilivalid.msg_fr="PartieNumeroImmeuble doit être univoque à l'intérieur du même immeuble";
            !!@ ilivalid.msg_it="Il NumeroParteFondo deve essere univoco all'interno dello stesso fondo";
            !! AGI SH: Failcase umgesetzt;
            UNIQUE CH087651: WHERE DEFINED(NummerTeilgrundstueck): NummerTeilgrundstueck, Grundstueck->Nummer, Grundstueck->NBIdent;

            !!@ ilivalid.msg="Bei Grundstueck mit istVollstaendig=true und mit nur 1 Objekt in Bergwerk muss NummerTeilgrundstueck leer sein";
            !!@ ilivalid.msg_de="Bei Grundstueck mit istVollstaendig=true und mit nur 1 Objekt in Bergwerk muss NummerTeilgrundstueck leer sein";
            !!@ ilivalid.msg_fr="Pour un immeuble dont l'attribut EstComplete=true, et formé d'un seul objet dans la table Mine, l'attribut PartieNumeroImmeuble doit être vide";
            !!@ ilivalid.msg_it="Per i fondi con integralità = si, e un solo oggetto in miniera, numero_parte_fondo deve restare vuoto";
            !! AGI SH: Failcase umgesetzt;
            MANDATORY CONSTRAINT CH087652: (
                Grundstueck->IstVollstaendig AND INTERLIS.objectCount(THIS->Bergwerk) == 1) => NOT(DEFINED(THIS->Bergwerk->NummerTeilgrundstueck)
                );

        END v_Bergwerk;

    END Grundstuecke_Validierung;

END DMAV_V1_0_Grundstuecke_Validierung.
